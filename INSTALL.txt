.. This document is formatted using the ReST syntax.

=================================
 Aegir Installation Instructions
=================================

------------------------------------------------------------------------------------------------------------------
 This document describes briefly how to install a multi-platform, single-server Aegir Drupal provisionning system.
------------------------------------------------------------------------------------------------------------------


Aegir requirements
==================

This section describes what is expected of the servers Aegir is running
on.

Aegir must run some UNIX flavour because the majority of functionality
in this system occurs in the back-end, through command line scripting.
There are also several features (such as symlinks), that are not
available to users on Windows. There are no plans currently to add
windows support.

The level of access required to be able to configure this system is
very far beyond what is commonly available to users with shared hosting.

Following instructions will provide example commands for a Debian-like
distribution. They are assumed to be run as root user. Prefix them with
sudo if you are working with a privileged user instead of root.


Web server
----------

You will need at least one dedicated web server, running Apache. We
generally work with Apache 2 but we should be compatible with the 1.x
series. You will need root access to that server and the server must
be reserved for Aegir. Sharing the server with other control panels
such as Cpanel, Plesk or AlternC will very likely create problems and
is not supported.

Shell commands::

 apt-get install apache2


PHP 5.2
-------

Since Aegir strongly depends on Drush, we therefore depend on PHP 5.2
or above. You also need to have the commandline version of PHP to run
Drush properly and the MySQL extensions.

Shell commands::

 apt-get install php5 php5-cli php5-mysql


Database server
---------------

You will require a database server, obviously. Aegir currently only 
supports MySQL. It is preferable to use a dedicated server since Aegir 
will create database users and will require a privileged user.

Shell commands::

 apt-get install mysql-server


Mail transfer agent
-------------------

Aegir requires an MTA (Mail Transfer Agent) installed on your webserver
in order to be able to install new sites to your new platform. If you
don't have an MTA, the site installation will fail with message like
"could not send email". Additional messages will show that site has been
removed because of this problem. To remedy the situation simply install
an MTA like sendmail, postfix, or exim and do the minimal configuration.

Shell commands::

 apt-get install postfix


Aegir user
----------

The provision framework of Aegir requires that the scripts run as a 
non-root system account, to ensure that it can correctly set the file
permissions on the hosted files. 

Also to ensure that the file permissions of the hosted sites are
always as safe as can be, and especially to make sure that the web
server does not have the ability to modify the code of the site, the
configured system account needs to be a member of the web server group,
in order to be able to correctly set the file permissions.

More detailed instructions on this topic will be given later in the web 
installation wizard.

This document assumes the Aegir user is ``aegir``, its home directory is
``/var/aegir`` and the webserver group is ``www-data``. You can choose
another username if desired.

In addition we will create a directory layout for Aegir configuration
and backups.

Shell commands::

 adduser --system --group --home /var/aegir aegir
 adduser aegir www-data    #make aegir a user of group www-data
 mkdir -p /var/aegir/config/vhost.d
 mkdir -p /var/aegir/backups
 chmod 0711 /var/aegir/config
 chmod 0700 /var/aegir/backups
 chown -R aegir /var/aegir/*


CVS commands
------------

If you want to install Aegir from CVS you will need to install ``cvs``
command in the server system.

Shell commands::

 apt-get install cvs


Aegir installation instructions
===============================

This section deals with the installation of Aegir proper. Those
instructions limit themselves to getting you into the Aegir wizard,
which will then give you further configuration instructions.

You can choose to install Aegir from CVS or by using drush. If you 
opt for drush, make sure the versions reported in the output is correct.

Installation instructions presents you in each step both
alternative instructions to checkout from CVS or download with drush 
each component of Aegir. Be warned that in the hours following a new
release, drush will not catch up the correct versions.

All instructions and in general all commands must be run as aegir user,
so all permissions are always set correctly.

To become aegir user you can issue this command::

  su -s /bin/sh aegir

(Note you must run this as root or prefix with sudo).

Additionally to make following instructions generic and not dependant on
a concrete Drupal or Aegir version. We will use bash environment
variables for this. So current Drupal is 6.14 and Aegir release is
0.4-alpha2.

You should replace following command for current versions at the time
you are reading this document.

Shell commands::

  export DRUPAL_DIR=/var/aegir/drupal-6.14
  export AEGIR_TAG=DRUPAL-6--0-4-ALPHA2


Installing drush 2.0
--------------------

At the time this document is being written current drush stable version
is 2.0. Perhaps a newer version does exist and this document is not
updated yet. You should use the latest stable version of the 2.x branch.

Shell commands for cvs::

 cd /var/aegir
 export CVSROOT=:pserver:anonymous:anonymous@cvs.drupal.org:/cvs/drupal
 cvs co -d drush -rDRUPAL-6--2-0 contributions/modules/drush

Shell commands for package download::

 cd /var/aegir
 wget http://ftp.drupal.org/files/projects/drush-All-Versions-2.0.tar.gz
 tar -xvzf drush-All-Versions-2.0.tar.gz
 rm drush-All-Versions-2.0.tar.gz

Additionally we will export another environment variable for the purpose
of referencing drush executable in a shorter way.

Shell commands::

  export DRUSH=/var/aegir/drush/drush.php


Downloading provision framework
-------------------------------

The provision framework is not a drupal module but a drush extension. So
it must be placed in ``/var/aegir/.drush`` for drush to be able to find it.

Shell commands for cvs::

 cvs co -d .drush/provision -r$AEGIR_TAG contributions/modules/provision

Shell commands for drush::

 mkdir .drush
 $DRUSH dl provision --destination=.drush


Installing drupal
-----------------

Drush is able to download latest version of Drupal. Be sure that the
downloaded version is the same you put in $DRUPAL_DIR in above.

Shell commands::

 $DRUSH dl drupal
 cd $DRUPAL_DIR


Installing hostmaster profile
-----------------------------

Shell commands for cvs::

 cvs co -d profiles/hostmaster -r$AEGIR_TAG contributions/profiles/hostmaster
 
Shell commands for drush::

 $DRUSH dl --destination=./profiles hostmaster


Installing hosting module
-------------------------

Shell commands for cvs::

 cvs co -d profiles/hostmaster/modules/hosting -r$AEGIR_TAG contributions/modules/hosting

Shell commands for drush::

 mkdir profiles/hostmaster/modules
 $DRUSH dl --destination=./profiles/hostmaster/modules hosting


Installing install_profile_api module
-------------------------------------

Hostmaster profile depends on Install Profile API module version 2.1. 
Following command will force to download correct version.

Shell commands::

 $DRUSH dl --destination=./profiles/hostmaster/modules install_profile_api-6.x-2.1


Checking out the optional components
------------------------------------

Aegir has its own theme which you can use. Theme is called Eldir. It is
also suggested that you install admin_menu to ease administration.


Installing Eldir theme
~~~~~~~~~~~~~~~~~~~~~~

Shell commands for cvs::

 cvs co -d profiles/hostmaster/themes/eldir -r$AEGIR_TAG contributions/themes/eldir
 
Shell commands for drush::

 mkdir profiles/hostmaster/themes
 $DRUSH dl --destination=./profiles/hostmaster/themes eldir


Installing Admin menu module
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Shell commands::

 $DRUSH dl --destination=./profiles/hostmaster/modules admin_menu


Apache configuration
--------------------

Those instructions assume you are installing aegir in ``$AEGIR_DOMAIN``,
where ``AEGIR_DOMAIN = aegir.example.com``.

If you are running another non-Debian system you basically need to:

 1. create a virtual host for Aegir in /var/aegir/config/vhost.d/$AEGIR_DOMAIN
 2. include the Aegir apache configurations in Apache
 3. activate the mod_rewrite engine
 4. restart apache

Note some of those instructions must be run as a privileged user (root)
instead of Aegir's user. For the commands that need to be run as root,
run these in a separate terminal, to ensure that the Aegir user retains
the environment variables defined before in the installation process.
The instructions to be run as the aegir user assume that the commands
will be run against the current directory (i.e they may assume
environment variables and relative paths).


Creating Aegir's virtualhost
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Hostmaster provides an example virtualhost for apache. Copy it to Aegir's
virtual hosts directory and **modify** it to suit your needs,
particularly the path leading to the Drupal core ($DRUPAL_DIR in the
examples above).

Shell commands::
 export AEGIR_DOMAIN=aegir.example.com
 cp profiles/hostmaster/apache2.conf.txt ../config/vhost.d/$AEGIR_DOMAIN
 # edit and configure


Configuring Aegir in Apache
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Aegir VirtualHosts for Apache are stored at ``/var/aegir/config/vhost.d``
(if you have not changed default locations). So Apache must be
instructed to read configurations from there. In Debian systems each 
configuration file located at ``/etc/apache2/conf.d`` is read on
initialization. If you are using another system, you can put ``Include
/var/aegir/config/vhost.d`` in a file inside /etc/httpd/conf.d/ or
directly at the end of httpd.conf.

Additionally rewrite module must be enabled and apache restarted.

Shell commands as root::

 a2enmod rewrite
 echo "Include /var/aegir/config/vhost.d/" > /etc/apache2/conf.d/aegir
 /etc/init.d/apache2 restart


Checkpoint!
-----------

At this point, you have checked out all the code and setup your basic
Drupal (Drupal core, hosting, hostmaster and eldir) that will be the
Aegir frontend and the backend system (provision and drush). Your
filesystem layout should look something like that::

 /var/aegir/drupal-6.x
 /var/aegir/drupal-6.x/profiles/hostmaster
 /var/aegir/drupal-6.x/profiles/hostmaster/modules/hosting
 /var/aegir/drupal-6.x/profiles/hostmaster/modules/install_profile_api
 /var/aegir/drupal-6.x/profiles/hostmaster/themes/eldir
 /var/aegir/drupal-6.x/sites/aegir.example.com
 /var/aegir/config/vhost.d
 /var/aegir/backups
 /var/aegir/drush/drush.php
 /var/aegir/.drush/provision

Variations on this are acceptable (for example, the Drush Debian
package works out of ``/usr/bin/drush`` and that's fine), but you are
better to stick with those if you really want to get through this. The
remaining of the documentation here will assume that layout.


Database configuration
----------------------

Here you want to make a basic database configuration for the Drupal
you are going to install. You want to run those commands using your
database 'root' user.

SQL commands::

 CREATE DATABASE aegir;
 GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, \
  CREATE TEMPORARY TABLES, LOCK TABLES ON aegir.* TO \
  'aegir'@'localhost' IDENTIFIED BY 'XXXXXXXX';


DNS Configuration
-----------------

Configuring DNS is up to you. Currently Aegir does nothing with DNS. 

As a help trick, if you are installing Aegir in local to try ant test
it, you can do local DNS by adding entries to file ``/etc/hosts``. First
line of this file looks like:

``127.0.0.1  localhost your-machine-name``

Simply add all domains you want to this line. Ej:

``127.0.0.1  localhost your-machine-name $AEGIR_DOMAIN other1 other2``


Install Drupal
------------------

We are almost ready to install the first Drupal using this installation
profile. The installer is going to complain about the missing
settings.php.

It is recommended that you create the aegir site as a real site in the 
sites/ directory. The following commands will create this site directory
and create the settings.php and files directory with the appropriate 
permissions to proceed through the installer.

Run these commands as the aegir user.

Shell commands::

 mkdir sites/$AEGIR_DOMAIN
 cp sites/default/default.settings.php sites/$AEGIR_DOMAIN/settings.php
 chmod g+w sites/$AEGIR_DOMAIN/settings.php
 mkdir sites/$AEGIR_DOMAIN/files
 chmod 2770 sites/$AEGIR_DOMAIN/files
 chgrp www-data sites/$AEGIR_DOMAIN/settings.php
 chgrp www-data sites/$AEGIR_DOMAIN/files
 
Now point your browser to ``http://$AEGIR_DOMAIN/``, select the
hostmaster install profile, enter the database credentials you setup 
above and then the installer will prompt you to secure the permissions
on the settings.php file again.

Shell commands::

 chmod a-w sites/$AEGIR_DOMAIN/settings.php


Follow the wizard
-----------------

You should now be in the installation wizard. The wizard is usually
self-documenting so you should just be able to follow the instructions
in the wizard to configure Aegir to properly use the webserver and
database server.

