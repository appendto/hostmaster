.. This document is formatted using the ReST syntax.

==========================
Aegir Upgrade Instructions
==========================

-----------------------------------------------------------------------------
This document describes briefly how to upgrade an existing Aegir installation
-----------------------------------------------------------------------------

Upgrading the Drupal core safely
================================

If you want to use provision to upgrade your Aegir installation, you
can, but it's a bit more tricky than with a usual site because you
cannot (yet) use the regular frontend to drive the backend. So you need to go through some extra steps and the commandline to upgrade Aegir.

The first step is to import and verify the "default" site so it has a
proper configuration. Then it can be migrated to a new platform. We
use backup and deploy because the upgrade is likely to fail and want
to test the new site first.

Note that those commands assume you have already updated provision to
a proper version, see below.

Shell commands::
 cd /var/aegir
 ./drush/drush.php dl drupal
 cd drupal-6.12
 cvs co -d profiles/hostmaster -rDRUPAL-6--0-3 contributions/profiles/hostmaster
 /var/aegir/drush/drush.php dl hosting eldir install_profile_api
 cd /var/aegir
 # also checkout any modules you may have enabled in the d5 platform
 # now you want to add the platform in the frontend (Create content -> platform) and wait for the task to be processed
 cd ../drupal-5.x
 /var/aegir/drush/drush.php --verbose=2 provision verify
 /var/aegir/drush/drush.php --verbose=2 provision import default
 /var/aegir/drush/drush.php --verbose=2 provision verify default
 /var/aegir/drush/drush.php --verbose=2 provision backup default ~/default.tar.gz
 cd ../drupal-6.12
 /var/aegir/drush/drush.php --verbose=2 provision verify
 /var/aegir/drush/drush.php --verbose=2 provision deploy d6.aegir.example.com ~/default.tar.gz
 # review changes, see if it works to your liking, when you're done:
 /var/aegir/drush/drush.php --verbose=2 provision deploy aegir.example.com ~/default.tar.gz
 /var/aegir/drush/drush.php --verbose=2 provision delete d6.aegir.example.com
 crontab -e # change root to new platform, make sure you have a --uri=aegir.example.com

Note that the import/verify of the 'default' site is required only
because that site is typically ignored in Aegir. This procedure will
migrate your main frontend away from that 'default' setup. See
http://drupal.org/node/453540 for details.

Upgrading Hostmaster from 0.2 (Drupal 5)
========================================

The major change between 0.3 and 0.2 is that 0.3 now targets the
Drupal 6 platform on the frontend (the backend still supports both
Drupal 5 and 6). We also switch away from using the sites/default/ for
Aegir in 0.3. So the upgrade procedure is basically the "Upgrading the
Drupal core safely" procedure detailed above.

Make sure you also checkout the install_profile_api module (>=2.1) as
it is a new dependency.

Upgrading Hostmaster from 0.1
=============================

Upgrading hostmaster should be as simple as removing the provision and
drush modules from your profiles/hostmaster/modules directory. You
also need to create a new drush and provision checkout. Finally, you
can remove the drush.php symlink.

You will also need to update the hosting module and run update.php so
that new changes to the database are taken into account. This will
trigger platform verification and other cleanup tasks. Starting with
0.2, this process will be automated (see the above process).

Finally, you will need to put the path to that new drush in the
webserver node configuration. Rerunning the wizard will prompt you for
that. Make sure you also run the hosting setup command.

Shell commands::
 export CVSROOT=:pserver:anonymous:anonymous@cvs.drupal.org:/cvs/drupal
 cd /var/aegir
 cvs co -d drush -rDRUPAL-6--2-0 contributions/modules/drush
 mkdir .drush
 cvs co -d .drush/provision -rDRUPAL-6--0-3 contributions/modules/provision
 rm drupal-5.x/drush.php
 rm -r drupal-5.x/profiles/hostmaster/modules/provision
 rm -r drupal-5.x/profiles/hostmaster/modules/drush
 cvs up -A drupal-5.x/profiles/hostmaster/modules/hosting
 # here run update.php on the site and setup your drush path
 cd drupal-5.x && ../drush/drush.php hosting setup

The above commands need to be ran as your "aegir" user, especially the
last step.

Upgrading Hostslave platforms from 0.1
======================================

Provision has been migrated out of the platforms. It used to be
installed in the profiles/hostslave/modules directory. It is now in
~/.drush/provision. So you can simply cleanup the hostslave profile
and the virtual host created for the hostslave profile. You can also
remove the drush symlink.

Shell commands::
 cd /var/aegir
 rm -r drupal-6.x/profiles/hostslave
 rm config/vhost.d/hostslave
 rm drupal-6.x/drush.php

You should also delete the database created during the hostslave
install:

SQL commands::
 DROP DATABASE hostslave;
